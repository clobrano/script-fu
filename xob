#!/usr/bin/env bash
# XOB: Xdg-Open Bookmark
# Helper tool to open web bookmarks stored in $HOME/.bookmarks file
# each line of the bookmark file is expected to be made of two elements:
# - a keyword
# - the http link

BOOKMARKS="$HOME/Documents/bookmarks.yml"

# If no argument is passed, print the bookmarks
if [[ -z $1 ]]; then
    yq -r '.bookmarks[] | "\(.key) \(.link)"' ${BOOKMARKS} | column -t -s ' ' | sort
    exit 0
fi

matches=$(yq -r ".bookmarks[] | select((.key | index(\"${1}\")) != null) .link" ${BOOKMARKS} | wc -l)
if [[ $matches -eq 0 ]]; then
    echo "[!] No bookmarks with filter: $1"
    exit 1
fi

if [[ $matches -gt 1 ]]; then
    echo "[!] Too many ($matches) bookmarks with filter: $1"
    matches=$(yq -r ".bookmarks[] | select((.key | index(\"${1}\")) != null) .key" ${BOOKMARKS})
    for m in ${matches}; do
        echo $m: $(yq -r ".bookmarks[] | select((.key | index(\"${1}\")) != null) .link" ${BOOKMARKS}) 
    done
    exit 1
fi

link=$(yq -r ".bookmarks[] | select((.key | index(\"${1}\")) != null) .link" ${BOOKMARKS})
if [[ -z link ]]; then
    echo "[!] No bookmarks with filter: $1"
    exit 1
fi

xdg-open ${link} 2>&1>/dev/null
